{{- $architecture := or .architecture "arm64" -}}
{{- $image := or .image (printf "ubuntu-touch-hybris-rootfs-%s.tar.gz" $architecture) -}}
{{- $cdimagesmirror := or .cdimagesmirror "http://cdimage.ubuntu.com" -}}
{{- $phablet_password := or .phablet_password "" }}

architecture: {{ $architecture }}
actions:
  - action: recipe
    description: Setup base rootfs
    recipe: focal-base.yaml
    variables:
      architecture: {{ $architecture }}
      cdimagesmirror: {{ $cdimagesmirror }}
      skip_remove_apt_user: false

  - action: run
    description: "[Temporary] add WIP repos"
    # Note, this operation also updates packages in base image.
    chroot: true
    script: >-
      ../scripts/add-and-pin-repo.sh
      http://repo2.ubports.com/ focal_-_PR_lomiri_8 2001
      http://repo2.ubports.com/ focal_-_PR_ubuntu-touch-session_18 2001
      http://repo2.ubports.com/ focal_-_PR_repowerd_28 2001
    label: add-and-pin-repo.sh

    # TODO: should have a task pacakge at some point.
  - action: run
    description: Install packages
    chroot: true
    script: >-
      ../scripts/apt-install.sh --no-install-recommends
      ubuntu-minimal ubuntu-standard
      network-manager openssh-server hybris-usb lxc-android-config
      ubuntu-touch-session lomiri-indicator-network libnss-extrausers
      libqt5gui5-gles libqt5gui5-
      mir-graphics-drivers-android mir-graphics-drivers-android-caf
      repowerd
      nano bash-completion
      ubports-qa-scripts
    label: apt-install.sh

  - action: overlay
    description: Add Ubuntu Touch overlays
    source: ./ubuntu-touch/overlay
    destination: /

  - action: run
    descriptions: Run Ubuntu Touch hooks
    chroot: true
    script: ./ubuntu-touch/hooks/run-hooks.sh
    label: run-parts

  - action: recipe
    description: Finalizing image in debug mode.
    recipe: focal-finalize-debug.yaml
    variables:
      architecture: {{ $architecture }}
      image: {{ $image }}
      phablet_password: {{ $phablet_password }}